<template>    <div class="form-con">        <el-breadcrumb separator-class="el-icon-arrow-right">            <el-breadcrumb-item :to="{ path: '/' }">首页</el-breadcrumb-item>            <el-breadcrumb-item>民宿管理</el-breadcrumb-item>            <el-breadcrumb-item :to="{ path: '/addhomestay' }">添加民宿</el-breadcrumb-item>        </el-breadcrumb>        <div class="form-con2">            <el-form :model="homestayform" ref="homestayform" :rules="homestayRules" >                <!--            分类选择-->                <el-row type="flex" class="row-bg">                    <el-col :span="12">                        <el-form-item label="所属分类" label-width="80px" v-model="homestayform.cid" prop="cid">                            <el-select v-model="homestayform.cid" filterable clearable placeholder="请选择" >                                <el-option                                        v-for="item in categorys"                                        :key="item.cid"                                        :label="item.cname"                                        :value="item.cid">                                </el-option>                            </el-select>                        </el-form-item>                    </el-col>                    <el-col :span="8">                        <el-form-item icon="el-icon-circle-plus" label-width="80px" label="民宿名称"  prop="hname">                            <el-input v-model="homestayform.hname" clearable maxlength="50" show-word-limit></el-input>                        </el-form-item>                    </el-col>                </el-row>                <el-row type="flex" class="row-bg">                    <el-col :span="8">                        <el-form-item label="民宿标签" label-width="80px" prop="htag">                            <el-input v-model="homestayform.htag" clearable></el-input>                        </el-form-item>                    </el-col>                    <el-col :span="8">                        <el-form-item label="民宿评分" label-width="80px" prop="hscore">                            <el-input v-model="homestayform.hscore" clearable></el-input>                        </el-form-item>                    </el-col>                    <el-form-item label="民宿价格" label-width="80px" prop="hprice">                        <el-input v-model="homestayform.hprice" clearable></el-input>                    </el-form-item>                </el-row>                <el-row type="flex" class="row-bg">                    <el-col :span="8">                        <el-form-item label="城市省份" label-width="80px" prop="hprovince">                            <el-select v-model="homestayform.hprovince"  filterable  placeholder="请选择">                                <el-option                                        v-for="(value,index) in Province"                                        :key="index"                                        :label="value"                                        :value="value">                                </el-option>                            </el-select>                        </el-form-item>                    </el-col>                    <el-col :span="8">                        <el-form-item label="民宿城市" label-width="80px" prop="hcity">                            <el-select v-model="homestayform.hcity"  filterable  placeholder="请选择">                                <el-option                                        v-for="(value,index) in cityList"                                        :key="index"                                        :label="value"                                        :value="value">                                </el-option>                            </el-select>                        </el-form-item>                    </el-col>                    <el-col :span="8">                        <el-form-item label="城市区域" label-width="80px" prop="harea">                            <el-select v-model="homestayform.harea"  filterable  placeholder="请选择">                                <el-option                                        v-for="(value,index) in areaList"                                        :key="index"                                        :label="value"                                        :value="value">                                </el-option>                            </el-select>                        </el-form-item>                    </el-col>                </el-row>                <el-form-item label="民宿具体地址" prop="haddress">                    <el-input v-model="homestayform.haddress" clearable></el-input>                </el-form-item>                <el-form-item label="民宿描述" prop="hdesc">                    <el-input type="textarea" v-model="homestayform.hdesc" clearable  maxlength="255" show-word-limit></el-input>                </el-form-item>                <el-form-item label="民宿缩略图" prop="hthumb">                </el-form-item>                <el-form-item>                    <!--            1.前端代码                                    2.:action 请求后端控制器                                    3. onsuccess 函数判断 上传成功后 把url赋值相应的字段                                    4.handleThumbBefore前端验证上传图片类型 file.size file.type                                    5.后台 tp5 upload                                               -->                    <el-upload                            class="avatar-uploader"                            :action="uploadurl"                            :show-file-list="false"                            :on-success="handleThumbSuccess"                            :before-upload="handleThumbBefore">                        <img v-if="homestayform.hthumb" :src="IMGURL + homestayform.hthumb" class="avatar">                        <i v-else class="el-icon-plus avatar-uploader-icon"></i>                        <div class="el-upload__tip" slot="tip">只能上传jpg/png/webp文件，且不超过200kb,推荐图片比例1:1</div>                    </el-upload>                    <el-dialog :visible.sync="dialogVisible">                        <img width="100%" :src="dialogImageUrl" alt="">                    </el-dialog>                </el-form-item>                <el-form-item label="民宿轮播图" prop="hbanner">                </el-form-item>                <el-form-item>                    <el-upload                            :action="uploadurl"                            list-type="picture-card"                            :on-success="handleBannerSuccess"                            :on-remove="handleBannerRemove"                            :on-preview="handleBannerPreview"                            multiple                            :limit="5"                            :on-exceed="handleExceed"                            :file-list="bannerFileList">                        <i class="el-icon-plus"></i>                    </el-upload>                </el-form-item>                <el-form-item label="民宿详情" >                </el-form-item>                <el-form-item prop="hdetail">                    <RichText :menus="menuconfig" :value="homestayform.hdetail" fieldname="hdetail"                              @rich-change='sethdetail'></RichText>                </el-form-item>                <el-form-item label="入住须知">                </el-form-item>                <el-form-item prop="hnotice">                    <RichText :menus="menuconfig" :value="homestayform.hnotice" fieldname="hnotice"                              @rich-change='setnotice'></RichText>                </el-form-item>                <el-button type="primary" @click="handleSubmit">添加</el-button>            </el-form>        </div>    </div></template><script>    import instance from "../../../http/http";    import {IMGURL, SUCCESS, URL} from "../../../lib/base";    import E from 'wangeditor';    import RichText from "../../../components/rich-text/RichText";    import city from "../../../lib/city.json";    import {homestayRead,homestayUpdate} from "../../../http/homestay";    export default {        name: "editHomestay",        data() {            return {                IMGURL,                uploadurl: URL + '/admin/Upload/index',                //分类数组                categorys: [],                hid:0,                //民宿信息表单                homestayform:null,                //表单验证                homestayRules:{                    hname:[                        {required:true,message:'请输入民宿名称',trigger:"blur"},                        { min: 3, max: 50, message: '长度在 3 到 50 个字符', trigger: 'blur' }                    ],                    hdesc:[                        {required:true,message:'请输入民宿描述',trigger:"blur"},                        { min: 5, max: 255, message: '长度在 5 到 255 个字符', trigger: 'blur' }                    ],                    hthumb: [                        {required:true,message:'民宿缩略图不能为空',trigger:"blur"},                    ],                    hprice:[                        {required:true,message:'请输入民俗价格',trigger:"blur"},                    ],                    hprovince:[                        {required:true,message:'请选择所在省',trigger:["blur",'change']},                    ],                    hcity:[                        {required:true,message:'请选择所在城市',trigger:["blur",'change']},                    ],                    harea: [                        {required:true,message:'请选择所在城市区域',trigger:["blur",'change']},                    ],                    haddress:[                        {required:true,message:'请输入具体地址',trigger:"blur"},                    ],                    hbanner:[                        {required:true,message:'请上传图片',trigger:"blur"},                    ],                    hdetail:[                        {required:true,message:'请输入民宿详情',trigger:"blur"},                    ],                    hnotice: [                        {required:true,message:'请输入民宿入住须知',trigger:"blur"},                    ],                    cid:[                        {required:true,message:'请选择分类信息',trigger:["blur",'change']}                    ]                },                bannerArr: [],                //轮播图预览列表                bannerFileList:[],                dialogImageUrl: '',                dialogVisible: false,                menuconfig: [                    'head',  // 标题                    'bold',  // 粗体                    'fontSize',  // 字号                    'fontName',  // 字体                    'italic',  // 斜体                    'underline',  // 下划线                    'strikeThrough',  // 删除线                    'foreColor',  // 文字颜色                    'backColor',  // 背景颜色                    'link',  // 插入链接                    'list',  // 列表                    'justify',  // 对齐方式                    'quote',  // 引用                    'emoticon',  // 表情                    'image',  // 插入图片                    'table',  // 表格                    'video',  // 插入视频                    'code',  // 插入代码                    'undo',  // 撤销                    'redo'  // 重复                ],                configtext: "请输入入住须知",                city,                Province: [],            }        },        components: {            RichText        },        //实施改变的地区 城市数组 所以写到computed属性中        computed: {            //可变city hprovince            /*            *            * hprovince ===>对应省份的元素==>选中的省份对应的城市的映射            * */            cityList() {                let cityLists = [];                let current = this.city.find(ele => ele.name === this.homestayform.hprovince);                if (current) {                    cityLists = current.city.map(ele => ele.name);                }                return cityLists;            },            areaList(){                let areas =[];                areas;                let current = this.city.find(ele=>ele.name===this.homestayform.hprovince);                if(current){                    let current1 = current.city.find(ele=>ele.name===this.homestayform.hcity);                    if(current1){                        areas = current1.area;                    }                }                return areas;            }        },        methods: {            //初始化民宿信息            initHomestayForm(hid){                //                homestayRead(hid).then(res=>{                    if(res.data){                        //console.log(res.data);                        this.homestayform = res.data;                        this.bannerFileList = res.data.hbanner1.map(ele=>({name:res.data.hname,url:IMGURL+ele}));                        this.bannerArr = res.data.hbanner1;                        this.$message.success(res.msg);                    }else{                        this.$message.error(res.msg);                    }                }).catch(()=>{                })            },            //初始化分类            initCategory() {                instance.post('/admin/Category/showCategoryAll').then(res => {                    //console.log(res);                    if(res.code===SUCCESS){                        this.categorys = res.data;                        // this.$notify({                        //     title:'提示',                        //     message:res.msg,                        //     showClose:false,                        //     type:'success'                        // })                    }                    else{                        this.$notify({                            title:'警告',                            message:res.msg,                            showClose:false,                            type:'warning'                        })                    }                }).catch(() => {                });            },            //处理缩略图上传成功            handleThumbSuccess(res) {                if (res.code === SUCCESS) {                    this.$message.success(res.msg);                    this.homestayform.hthumb = res.imagepath;                } else {                    this.$message.error('缩略图上传失败');                }            },            //文件上传请求前,先验证文件类型和大小再请求 如果返回值为false 则不继续运行            handleThumbBefore(file) {                //前端验证                let {size, type} = file;                let uploadMaxSize = 200 * 1024;                //缩略图文件长传类型限制                let uploadType = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];                let sizeFlag = true, typeFlag = true;                sizeFlag = size < uploadMaxSize;                typeFlag = uploadType.some(ele => ele === type);                if (!typeFlag) {                    this.$message.error('上传图片只能是 jpg,image,webp');                }                if (!sizeFlag) {                    this.$message.error('上传图片大小小于200KB');                }                return sizeFlag && typeFlag;            },            //轮播上传            handleBannerSuccess(res) {                this.bannerArr.push(res.imagepath);                console.log(res.imagepath);                this.homestayform.hbanner = this.bannerArr.join(',');            },            //图片删除            handleBannerRemove(file) {                console.log(file);                let url = file.response?file.response.imagepath:file.url;                this.bannerArr = this.bannerArr.filter(ele => !url.includes(ele));                // this.bannerArr = this.bannerArr.filter(ele => ele != file.response.imagepath);                this.homestayform.hbanner = this.bannerArr.join(',');            },            handleBannerPreview(file) {                //console.log(file);                this.dialogVisible = true;                if(file.response){                    this.dialogImageUrl = IMGURL+file.response.imagepath;                }else{                    this.dialogImageUrl = file.url;                }                // console.log(file);            },            handleExceed(file) {                this.$message.warning(`当前限制选择 5 个文件，本次选择了 ${this.bannerArr.length} 个文件，共选择了 ${file.length + this.bannerArr.length} 个文件`);            },            //富文本编辑器初始化            initRichText() {                //配置                let that = this;                //放入dom元素                let editor = new E(this.$refs.hdetail);                //64位图片需要解析                //editor.customConfig.uploadImgShowBase64 = true;                //上传图片到服务器 但是这两种函数不能够同时使用                editor.customConfig.uploadImgServer = this.uploadurl;                editor.customConfig.uploadFileName = 'file';                //上传图片监听                editor.customConfig.uploadImgHooks = {                    customInsert: function (insertImg, result) {                        //console.log(result);                        let url = that.IMGURL + result.imagepath;                        insertImg(url);                    }                }                //监听事件 赋值给hdetail                editor.customConfig.onchange = (html) => {                    this.homestayform.hdetail = html;                }                editor.create();                editor.txt.html(this.homestayform?.hdetail);            },            //组件富文本 父子组件之间通信            setnotice(html, fieldname) {                //  console.log('changehnotice');                this.homestayform[fieldname] = html;            },            sethdetail(html, fieldname){                this.homestayform[fieldname]=html;            },            setProvince() {                this.Province = city.map(ele => ele.name);                // console.log(this.Province);            },            handleSubmit(){                homestayUpdate(this.hid,this.homestayform).then(res=>{                    if(res.code===SUCCESS){                        this.$notify({                            title:'提示',                            message:res.msg,                            type:"success",                            showClose:false                        })                    }else{                        this.$notify({                            title:'提示',                            message:res.msg,                            type:"error",                            showClose:true,                            duration:0                        })                    }                }).catch(()=>{                })            }        }, mounted() {            this.hid = this.$route.params.hid;            this.initHomestayForm(this.hid);            this.initCategory();            this.initRichText();            this.setProvince();        }    }</script><style>    .form-con {        padding: 50px 250px;        background-color: #F5FAFF;    }    .form-con2 {        background-color: white;        padding: 30px;        border-radius: 3px;        border-top: none;        border: 1px solid #f5f5f5;        box-shadow: 3px 2px 5px 2px #e4e3e3;        border-bottom-left-radius: 7px;        border-bottom-right-radius: 7px;        margin-top: 20px;        animation: myfirst 1.5s ease-in-out 0ms;        -webkit-animation: myfirst 1s ease-in-out 0ms;        -o-animation: myfirst 1s ease-in-out 0ms;        -moz-animation: myfirst 1s ease-in-out 0ms;    }    .avatar-uploader .el-upload {        border: 1px dashed #d9d9d9;        border-radius: 6px;        cursor: pointer;        position: relative;        overflow: hidden;    }    .avatar-uploader .el-upload:hover {        border-color: #409EFF;    }    .avatar-uploader-icon {        font-size: 28px;        color: #8c939d;        width: 100px;        height: 100px;        line-height: 100px;        text-align: center;    }    .avatar {        width: 100px;        height: 100px;        display: block;    }    .el-input__inner:focus {        border: 1px solid #4A69BD;    }    .el-upload__tip {        margin-top: -15px;        color: #4A69BD;    }    .avatar-uploader {        margin-top: -15px;    }    .el-dialog{        width: 500px;    }</style>